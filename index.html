<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kalkulator ADS">
    <meta name="application-name" content="Kalkulator ADS">

    <title>Kalkulator ADS</title>
    <link rel="manifest" id="manifest-placeholder" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-color: #f1f5f9;
            --screen-bg: #ffffff;
            --btn-num-bg: #ffffff;
            --btn-op-bg: #dbeafe;
            --btn-action-bg: #2563eb;
            --btn-print-bg: #ea580c;
            --btn-save-bg: #059669;
            --btn-clear-bg: #dc2626;
            --btn-tool-bg: #475569;
            --btn-rotate-bg: #0f766e;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 40% 1fr; 
            grid-template-areas: "toolbar" "display" "keypad";
        }

        body.external-keyboard-mode { grid-template-rows: auto 1fr auto; }

        @media (orientation: landscape) {
            body {
                grid-template-columns: 40% 60%;
                grid-template-rows: auto 1fr;
                grid-template-areas: "toolbar keypad" "display keypad";
            }
            body.external-keyboard-mode { grid-template-columns: 70% 30%; }
        }

        /* TOOLBAR */
        .toolbar {
            grid-area: toolbar; display: flex; justify-content: center; align-items: center;
            background: #e2e8f0; z-index: 5; min-height: 40px; padding: 5px; 
            gap: 10px; grid-gap: 10px; 
        }
        
        .btn-header {
            background-color: #2563eb; color: white; border: none; border-radius: 6px;
            padding: 8px 12px; font-size: 14px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        #btn-install { display: none; } 

        /* DISPLAY */
        .display-container {
            grid-area: display; background: var(--screen-bg); padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; z-index: 4;
            display: flex; flex-direction: column; overflow: hidden; cursor: pointer; 
        }

        #view-calc { display: flex; flex-direction: column; height: 100%; justify-content: space-between; }

        .receipt-list {
            flex: 1; overflow-y: auto; text-align: right; padding-right: 5px; margin-bottom: 5px;
        }

        /* --- PERBAIKAN UKURAN HURUF ITEM --- */
        .receipt-item {
            font-size: 28px; /* Fallback diperbesar */
            font-size: clamp(1.6rem, 4vh, 2.2rem); 
            color: #334155; 
            font-weight: 600; 
            border-bottom: 1px dashed #e2e8f0; padding: 6px 0;
            line-height: 1.3;
        }
        .receipt-item.active { color: var(--text-main); font-weight: 800; border-bottom: none; }

        .live-total-box {
            background: #f8fafc; border-top: 2px solid #2563eb; padding: 5px 0; text-align: right;
        }

        .total-label { display: block; font-size: 12px; color: var(--text-muted); }
        #main-display { 
            font-size: 40px;
            font-size: clamp(2.5rem, 6vh, 4rem); 
            font-weight: 800; color: var(--text-main); line-height: 1; 
        }

        /* PAYMENT MODE */
        .pay-mode-view { display: none; flex-direction: column; justify-content: space-between; height: 100%; padding: 5px 0; }
        .pay-row { display: flex; justify-content: space-between; align-items: center; }
        .label-pay { font-size: 16px; font-weight: bold; color: #64748b; }
        
        .btn-edit-total {
            background: #f59e0b; border: none; border-radius: 4px; color: white; padding: 5px 10px; font-weight: bold;
        }
        
        #pay-total { font-size: 24px; font-weight: bold; }
        #pay-input-display { 
            font-size: 40px;
            font-size: clamp(2.5rem, 7vh, 4rem); font-weight: 800; text-align: right; border-bottom: 3px solid #2563eb; 
        }
        #pay-change-display {
            font-size: 24px; font-weight: bold; text-align: right; color: var(--btn-save-bg);
        }

        /* KEYPAD */
        .keypad-container {
            grid-area: keypad; padding: 5px; display: grid; 
            gap: 4px; grid-gap: 4px;
            background-color: var(--bg-color);
            height: 100%; overflow-y: auto;
            grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr);
        }

        body.external-keyboard-mode .keypad-container {
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(2, 60px); 
            align-content: end; height: auto; padding-top: 0;
        }

        button {
            border: none; border-radius: 6px; 
            font-size: 24px;
            font-size: clamp(1.5rem, 4vh, 2.5rem); 
            font-weight: 700; cursor: pointer; color: var(--text-main); background: var(--btn-num-bg);
            box-shadow: 0 2px 0 #cbd5e1; display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }
        button:active { opacity: 0.7; transform: translateY(2px); }

        body.external-keyboard-mode .virtual-key { display: none !important; }

        .btn-tool { background-color: var(--btn-tool-bg); color: white; font-size: 14px; flex-direction: column; }
        .btn-undo { background-color: #f59e0b; color: white; font-size: 14px; flex-direction: column; }
        .btn-rotate { background-color: var(--btn-rotate-bg); color: white; font-size: 14px; flex-direction: column; }
        
        .btn-op { background-color: var(--btn-op-bg); color: #1e3a8a; }
        .btn-clear { background-color: var(--btn-clear-bg); color: white; font-size: 20px; }
        .btn-pay { background-color: var(--btn-action-bg); color: white; font-size: 16px; text-transform: uppercase; }
        .btn-eq { background-color: #2563eb; color: white; }

        /* Helpers */
        .sw-status { display: none; }
    </style>
</head>
<body id="body-app">

    <div class="toolbar" id="toolbar-area">
        <button class="btn-header" id="btn-install" onclick="installApp()">üì≤ Install</button>
    </div>

    <div class="display-container" id="display-area">
        <div id="view-calc">
            <div id="receipt-list" class="receipt-list"><div class="receipt-item active">0</div></div>
            <div class="live-total-box">
                <span class="total-label">Total Belanja:</span>
                <span id="main-display">0</span>
            </div>
        </div>

        <div id="view-pay" class="pay-mode-view">
            <div class="pay-row">
                <div class="label-group" style="display:flex; gap:5px; align-items:center;">
                    <span class="label-pay">TOTAL</span>
                    <button class="btn-edit-total" onclick="editTransaction()">UBAH</button>
                </div>
                <span id="pay-total">Rp 0</span>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div style="text-align:right; font-size:14px; color:#64748b;">Uang Pelanggan:</div>
                <div id="pay-input-display">0</div>
            </div>
            <div class="pay-row">
                <span class="label-pay">KEMBALI</span>
                <span id="pay-change-display">Rp 0</span>
            </div>
        </div>
    </div>

    <div class="keypad-container" id="keypad">
        <!-- BARIS 1 -->
        <button class="btn-tool" onclick="toggleSound()" id="btn-sound">üîä<br>Suara</button>
        <button class="btn-tool" onclick="connectBluetooth()" id="btn-bt">üñ®Ô∏è<br>Connect</button>
        <button class="btn-tool" onclick="showHistory()">üìú<br>Riwayat</button>
        <button class="btn-undo" onclick="undoLastAction()">‚Ü©Ô∏è<br>Batal</button>

        <!-- BARIS 2 -->
        <button class="btn-clear" onclick="clearAll()">AC</button>
        <button class="btn-rotate" onclick="toggleOrientation()">‚ü≥<br>Putar</button>
        <button id="btn-main-action" class="btn-pay" onclick="handleMainAction()">BAYAR</button>
        <button class="btn-backspace virtual-key" onclick="backspace()">‚å´</button>

        <!-- BARIS 3 -->
        <button onclick="appendNum('7')" class="virtual-key">7</button>
        <button onclick="appendNum('8')" class="virtual-key">8</button>
        <button onclick="appendNum('9')" class="virtual-key">9</button>
        <button class="btn-op virtual-key" onclick="appendOp('/')">√∑</button>

        <!-- BARIS 4 -->
        <button onclick="appendNum('4')" class="virtual-key">4</button>
        <button onclick="appendNum('5')" class="virtual-key">5</button>
        <button onclick="appendNum('6')" class="virtual-key">6</button>
        <button class="btn-op virtual-key" onclick="appendOp('*')">√ó</button>

        <!-- BARIS 5 -->
        <button onclick="appendNum('1')" class="virtual-key">1</button>
        <button onclick="appendNum('2')" class="virtual-key">2</button>
        <button onclick="appendNum('3')" class="virtual-key">3</button>
        <button class="btn-op virtual-key" onclick="appendOp('-')">-</button>

        <!-- BARIS 6 -->
        <button onclick="appendNum('0')" class="virtual-key">0</button>
        <button class="btn-zero-xx virtual-key" onclick="appendNum('00')">00</button>
        <button class="btn-zero-xx virtual-key" onclick="appendNum('000')">000</button>
        <button class="btn-op virtual-key" onclick="appendOp('+')">+</button>
    </div>

    <script>
        // --- SETUP DASAR ---
        const manifestData={"name":"Kalkulator ADS","short_name":"Kalkulator ADS","start_url":".","display":"standalone","background_color":"#f1f5f9","theme_color":"#2563eb","icons":[{"src":"data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>","sizes":"192x192","type":"image/svg+xml"}]};
        
        const manifestEl = document.getElementById('manifest-placeholder');
        if (manifestEl) {
            manifestEl.setAttribute('href',URL.createObjectURL(new Blob([JSON.stringify(manifestData)],{type:'application/json'})));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('btn-install').style.display = 'inline-flex'; });
        async function installApp() { if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; document.getElementById('btn-install').style.display='none'; } }
        
        // --- FULLSCREEN & ORIENTASI ---
        async function attemptFullScreen() { 
            if(!document.fullscreenElement && document.documentElement.requestFullscreen){ 
                try { await document.documentElement.requestFullscreen(); } catch(e) {}
            } 
        }
        document.body.addEventListener('click', attemptFullScreen); 
        document.body.addEventListener('touchstart', attemptFullScreen);

        async function toggleOrientation() {
            await attemptFullScreen();
            const type = screen.orientation.type;
            try {
                if (type.startsWith('portrait')) await screen.orientation.lock('landscape');
                else await screen.orientation.lock('portrait');
            } catch (err) {
                console.log("Lock failed:", err);
                try { screen.orientation.unlock(); } catch(e){}
                alert("Gagal mengunci. Pastikan sudah 'Layar Penuh' (klik layar dulu).");
            }
        }

        // --- PWA UPDATE AUTOMATION (PERBAIKAN) ---
        if('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(reg => {
                    // Paksa cek update ke server setiap kali aplikasi dibuka
                    reg.update();
                }).catch(err => console.log('SW fail', err));

                // Jika ada SW baru yang aktif (Update selesai), reload halaman
                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            });
        }

        // --- VARIABEL & LOGIC ---
        let expression="", totalBill=0, paymentInput="", isPaymentMode=false, isSoundOn=true;
        let printerDevice=null, printerCharacteristic=null, inputHistory=[], lastTap=0;
        window.audioCtx = null;

        const receiptList = document.getElementById('receipt-list');
        const mainDisplay = document.getElementById('main-display'); 
        const payTotalDisplay = document.getElementById('pay-total');
        const payInputDisplay = document.getElementById('pay-input-display');
        const payChangeDisplay = document.getElementById('pay-change-display');
        const btnMain = document.getElementById('btn-main-action');
        const btnSound = document.getElementById('btn-sound');
        const btnBt = document.getElementById('btn-bt');

        // --- DOUBLE TAP ---
        document.getElementById('display-area').addEventListener('click', (e) => {
            const currentTime = new Date().getTime();
            if ((currentTime - lastTap) < 300 && (currentTime - lastTap) > 0) {
                e.preventDefault(); document.body.classList.toggle('external-keyboard-mode');
            } 
            lastTap = currentTime;
        });

        // --- KEYBOARD & MOUSE ---
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            
            // Cegah aksi default browser untuk tombol kalkulator (seperti scroll)
            if(['+', '-', '*', '/', 'Enter', 'Backspace', 'Escape', '='].includes(key)) event.preventDefault();

            // Aktifkan mode keyboard eksternal otomatis
            if (!document.body.classList.contains('external-keyboard-mode')) {
                document.body.classList.add('external-keyboard-mode');
            }

            if (!isNaN(key) && key !== ' ') {
                appendNum(key);
            } else if (['+', '-', '*', '/'].includes(key)) {
                appendOp(key);
            } else if (key === 'Enter' || key === '=') {
                // LOGIKA ENTER:
                // 1. Mode Hitung -> Pindah ke Bayar
                // 2. Mode Bayar -> Cetak Struk
                handleMainAction();
            } else if (key === 'Backspace') {
                backspace();
            } else if (key === 'Escape') {
                clearAll();
            } else if (key === 'z' && (event.ctrlKey || event.metaKey)) {
                undoLastAction();
            }
        });

        // --- PWA UPDATE AUTOMATION (DISEMPURNAKAN) ---
        if('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(reg => {
                    // Paksa cek update ke server setiap kali aplikasi dibuka
                    reg.update();

                    // Deteksi jika ada versi baru yang sedang diunduh
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            // Jika versi baru selesai diunduh dan siap
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Kirim sinyal untuk langsung melewati fase "waiting" dan aktifkan
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                }).catch(err => console.log('SW fail', err));

                // Jika Service Worker baru mengambil alih kendali, muat ulang aplikasi agar update tampil
                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            });
        }

        // --- CORE FUNCTIONS ---
        function scrollToBottom() { setTimeout(() => { receiptList.scrollTop = receiptList.scrollHeight; }, 10); }
        
        // Format visual helper
        function formatVisual(text) {
            if (!text) return "";
            let vis = text.replace(/\*/g, ' √ó ').replace(/\//g, ' √∑ ');
            return vis.replace(/\d+/g, (n) => parseInt(n).toLocaleString('id-ID'));
        }

        function initAudio() { if(!window.audioCtx && (window.AudioContext||window.webkitAudioContext)) window.audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        function playClickSound() {
            if(!isSoundOn) return; initAudio(); if(!window.audioCtx) return;
            if(window.audioCtx.state === 'suspended') window.audioCtx.resume();
            const osc = window.audioCtx.createOscillator(); const g = window.audioCtx.createGain();
            osc.connect(g); g.connect(window.audioCtx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(1200, window.audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, window.audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, window.audioCtx.currentTime+0.05);
            osc.start(); osc.stop(window.audioCtx.currentTime+0.05);
        }
        function toggleSound() { isSoundOn = !isSoundOn; btnSound.innerHTML = isSoundOn ? 'üîä<br>Suara' : 'üîá<br>Mute'; if(isSoundOn) playClickSound(); }
        document.getElementById('keypad').addEventListener('click', (e) => { if(e.target.closest('button')) playClickSound(); });

        function saveState() { if(inputHistory.length > 20) inputHistory.shift(); inputHistory.push(expression); }
        function undoLastAction() { if(isPaymentMode) return; if(inputHistory.length>0){ expression = inputHistory.pop(); updateDisplay(); } }

        function updateDisplay() {
            if (!isPaymentMode) {
                if (!expression) {
                    receiptList.innerHTML = '<div class="receipt-item active">0</div>'; mainDisplay.innerText = "0";
                } else {
                    // Split berdasarkan + dan - untuk baris baru
                    let parts = expression.split(/([+\-])/);
                    let html = '';
                    
                    const createItem = (op, content, isActive) => {
                        let formatted = formatVisual(content);
                        let subRes = "";
                        if (content.match(/[\*\/]/) && !content.match(/[\*\/]$/)) {
                            try {
                                let val = eval(content);
                                if (!isNaN(val)) subRes = "= " + val.toLocaleString('id-ID');
                            } catch(e) {}
                        }
                        
                        let itemStyle = subRes ? 'display:flex; justify-content:space-between;' : '';
                        let rightSide = subRes ? `<span style="opacity:0.8">${subRes}</span>` : '';
                        
                        return `<div class="receipt-item ${isActive}" style="${itemStyle}">
                            <span>${op} ${formatted}</span>
                            ${rightSide}
                        </div>`;
                    };

                    if (parts.length > 0) {
                        let content = parts[0];
                        if (content !== "" || parts.length === 1) {
                             let isActive = (parts.length === 1) ? 'active' : '';
                             html += createItem('', content || '0', isActive);
                        }
                    }

                    for (let i = 1; i < parts.length; i += 2) {
                        let operator = parts[i];
                        let content = parts[i+1] || "";
                        let isActive = (i + 2 >= parts.length) ? 'active' : '';
                        html += createItem(operator, content, isActive);
                    }
                    
                    receiptList.innerHTML = html;
                    
                    try {
                        let evalExpr = expression;
                        if(['+','-','*','/'].includes(evalExpr.slice(-1))) evalExpr = evalExpr.slice(0,-1);
                        if(evalExpr) mainDisplay.innerText = eval(evalExpr).toLocaleString('id-ID');
                    } catch (e) { }
                }
                scrollToBottom();
            } else {
                let val = parseInt(paymentInput || "0");
                payInputDisplay.innerText = val.toLocaleString('id-ID');
                let change = val - totalBill;
                if (change >= 0) {
                    payChangeDisplay.innerText = "Rp " + change.toLocaleString('id-ID');
                    payChangeDisplay.style.color = "#059669";
                } else {
                    payChangeDisplay.innerText = "Kurang Rp " + Math.abs(change).toLocaleString('id-ID');
                    payChangeDisplay.style.color = "#dc2626";
                }
            }
        }

        function appendNum(num) {
            if(!isPaymentMode) { saveState(); if(expression==="0" && num!==".") expression=""; expression+=num; }
            else { if(paymentInput.length>12) return; paymentInput+=num; }
            updateDisplay();
        }
        function appendOp(op) {
            if(isPaymentMode || expression==="") return;
            // Tidak ada hitung otomatis (collapse) agar list barang terjaga
            saveState();
            if(['+','-','*','/'].includes(expression.slice(-1))) expression = expression.slice(0,-1)+op;
            else expression+=op;
            updateDisplay();
        }
        function backspace() {
            if(!isPaymentMode) { saveState(); expression = expression.slice(0,-1); if(expression==="") expression="0"; }
            else paymentInput = paymentInput.slice(0,-1);
            updateDisplay();
        }
        function clearAll() { if(!isPaymentMode) saveState(); expression=""; paymentInput=""; totalBill=0; isPaymentMode=false; switchModeUI(false); updateDisplay(); }
        function editTransaction() { isPaymentMode=false; paymentInput=""; switchModeUI(false); }

        function calculate() {
            try {
                if(!expression) return 0;
                let evalExpr = expression;
                if(['+','-','*','/'].includes(evalExpr.slice(-1))) evalExpr = evalExpr.slice(0,-1);
                if(!evalExpr) return 0;
                let result = eval(evalExpr);
                totalBill = result;
                mainDisplay.innerText = result.toLocaleString('id-ID');
                return result;
            } catch(e) { return 0; }
        }

        function handleMainAction() {
            if(!isPaymentMode) {
                let total = calculate();
                if(total <= 0) { alert("Total 0 atau Error."); return; }
                totalBill = total; paymentInput=""; isPaymentMode=true;
                payTotalDisplay.innerText = "Rp " + totalBill.toLocaleString('id-ID');
                switchModeUI(true); updateDisplay();
            } else finishTransaction(true);
        }

        function switchModeUI(isPay) {
            const vCalc = document.getElementById('view-calc'); const vPay = document.getElementById('view-pay');
            if(isPay) { vCalc.style.display='none'; vPay.style.display='flex'; document.body.classList.add('mode-payment'); btnMain.innerText="üñ®Ô∏è CETAK"; }
            else { vCalc.style.display='flex'; vPay.style.display='none'; document.body.classList.remove('mode-payment'); btnMain.innerText="BAYAR"; }
        }

        async function finishTransaction(print) {
            let pay = parseInt(paymentInput || "0");
            if(pay < totalBill) { alert("Uang kurang!"); return; }
            let change = pay - totalBill;
            
            if (print) {
                if (!printerCharacteristic) {
                    if(confirm("Printer belum terhubung. Hubungkan sekarang?")) await connectBluetooth();
                }
                
                if (printerCharacteristic) {
                    saveHistory(totalBill, pay, change);
                    await printReceipt(totalBill, pay, change);
                    clearAll();
                } else {
                    if(confirm("Gagal konek. Simpan saja?")) { saveHistory(totalBill, pay, change); clearAll(); }
                }
            } else {
                saveHistory(totalBill, pay, change);
                clearAll();
            }
        }

        function saveHistory(total, pay, change) {
            let history = JSON.parse(localStorage.getItem('tx_history')) || [];
            history.unshift({ date: new Date().toLocaleString('id-ID'), total: total, pay: pay, change: change });
            if(history.length > 50) history.pop();
            localStorage.setItem('tx_history', JSON.stringify(history));
        }

        function showHistory() {
            let h = JSON.parse(localStorage.getItem('tx_history')) || [];
            if(h.length === 0) { alert("Belum ada riwayat."); return; }
            let msg = h.map(x => `üìÖ ${x.date}\nüí∞ Total: ${x.total.toLocaleString()}\nüíµ Bayar: ${x.pay.toLocaleString()}\n‚úÖ Kembali: ${x.change.toLocaleString()}\n-----------------`).join('\n');
            alert(msg);
        }

        // --- BLUETOOTH (SIMPLE STABLE VERSION) ---
        async function connectBluetooth() {
            if (!navigator.bluetooth) {
                alert("Browser ini tidak mendukung koneksi Bluetooth langsung.\nHarap update Google Chrome ke versi terbaru (versi 56+).");
                return;
            }
            try {
                // Disconnect jika sudah terhubung untuk mereset status
                if (printerDevice && printerDevice.gatt.connected) {
                    printerDevice.gatt.disconnect();
                }

                printerDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }] });
                
                printerDevice.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await printerDevice.gatt.connect();
                // Delay penting untuk HP lama
                await new Promise(r => setTimeout(r, 500));
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                printerCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                btnBt.innerHTML = 'üü¢<br>Ready'; btnBt.style.backgroundColor = "#059669";
            } catch (e) { 
                alert("Gagal Konek: " + e); 
                onDisconnected(); 
            }
        }

        function onDisconnected() {
            btnBt.innerHTML = 'üñ®Ô∏è<br>Connect'; 
            btnBt.style.backgroundColor = "#475569";
            printerCharacteristic = null;
        }

        function strToBytes(str) {
            const bytes = [];
            for (let i = 0; i < str.length; i++) {
                let code = str.charCodeAt(i);
                if (code > 255) code = 63; 
                bytes.push(code);
            }
            return new Uint8Array(bytes);
        }

        async function printReceipt(total, pay, change) {
            if (!printerCharacteristic) { alert("Printer tidak terhubung!"); return; }
            try {
                const ESC = '\u001B'; const GS = '\u001D';
                const center = ESC + 'a' + '\u0001'; const left = ESC + 'a' + '\u0000';
                const boldOn = ESC + 'E' + '\u0001'; const boldOff = ESC + 'E' + '\u0000';
                const bigFont = GS + '!' + '\u0011'; const normalFont = GS + '!' + '\u0000';
                const init = ESC + '@';

                const now = new Date();
                const dateStr = now.toLocaleDateString('id-ID');
                const timeStr = now.toLocaleTimeString('id-ID');

                let evalExpr = expression;
                if(['+','-','*','/'].includes(evalExpr.slice(-1))) evalExpr = evalExpr.slice(0,-1);
                
                let rawParts = evalExpr.split(/([+\-])/);
                let printItems = [];
                
                if (rawParts.length > 0 && rawParts[0]) {
                    printItems.push({op: '', val: rawParts[0]});
                }
                
                for (let i = 1; i < rawParts.length; i += 2) {
                    if (rawParts[i+1]) {
                        printItems.push({op: rawParts[i], val: rawParts[i+1]});
                    }
                }

                let itemsOutput = "";
                let itemCount = 0;
                
                printItems.forEach((itemObj, index) => {
                    let cleanItem = itemObj.val.trim();
                    if(!cleanItem) return;
                    itemCount++;
                    
                    let qty = 1; let price = 0;
                    if(cleanItem.includes('*')) {
                        let parts = cleanItem.split('*');
                        let v1 = parseInt(parts[0]); let v2 = parseInt(parts[1]);
                        if(!isNaN(v1) && !isNaN(v2)) { price = Math.max(v1, v2); qty = Math.min(v1, v2); }
                    } else { try { price = parseInt(eval(cleanItem)); } catch(e) { } }
                    
                    let sign = (itemObj.op === '-') ? '- ' : ''; 
                    
                    // --- UPDATE CETAK STRUK: TAMBAHKAN TOTAL JIKA QTY > 1 ---
                    let lineTotal = qty * price;
                    itemsOutput += `Brg ${index + 1} : ${qty} x ${sign}Rp ${price.toLocaleString('id-ID')}`;
                    if(qty > 1) {
                        itemsOutput += ` = Rp ${lineTotal.toLocaleString('id-ID')}`;
                    }
                    itemsOutput += `\n`;
                    // ---------------------------------------------------------
                });

                let summaryLine = `Jml Jenis Barang ${itemCount}\n`;

                let receiptText = 
                    init + 
                    center + boldOn + bigFont + "TOKO ADS" + normalFont + boldOff + "\n" +
                    "0812-3085-078 (WA)\n" +
                    "Jl. Sukodono No.92 Ganting\n" +
                    "Kec. Gedangan, Kab. Sidoarjo\n" +
                    "--------------------------------\n" +
                    left + 
                    `Tgl : ${dateStr} ${timeStr}\n` +
                    "--------------------------------\n" +
                    itemsOutput + "\n" + summaryLine +
                    "--------------------------------\n" +
                    boldOn + 
                    `TOTAL   : Rp ${total.toLocaleString('id-ID')}\n` +
                    boldOff +
                    `BAYAR   : Rp ${pay.toLocaleString('id-ID')}\n` +
                    `KEMBALI : Rp ${change.toLocaleString('id-ID')}\n` +
                    "--------------------------------\n" +
                    center + "Pesan Barang W.A: 0856-4883-0413\n" +
                    "Terima Kasih, Semoga Berkah\n\n\n";

                let encodedData;
                if (typeof TextEncoder !== 'undefined') {
                    encodedData = new TextEncoder().encode(receiptText);
                } else {
                    encodedData = strToBytes(receiptText);
                }
                
                const maxChunk = 50; 
                for (let i = 0; i < encodedData.length; i += maxChunk) {
                    const chunk = encodedData.slice(i, i + maxChunk);
                    await printerCharacteristic.writeValue(chunk);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            } catch (error) { 
                alert("Gagal mencetak: " + error); 
                onDisconnected();
            }
        }
    </script>
</body>
</html>
