<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kalkulator ADS">
    <meta name="application-name" content="Kalkulator ADS">

    <title>Kalkulator ADS</title>
    <link rel="manifest" id="manifest-placeholder" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-color: #f1f5f9;
            --screen-bg: #ffffff;
            --btn-num-bg: #ffffff;
            --btn-op-bg: #dbeafe;
            --btn-action-bg: #2563eb;
            --btn-print-bg: #ea580c;
            --btn-save-bg: #059669;
            --btn-clear-bg: #dc2626;
            --btn-tool-bg: #475569;
            --btn-rotate-bg: #0f766e;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body {
            font-family: sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 40% 1fr; 
            grid-template-areas: "toolbar" "display" "keypad";
        }

        body.external-keyboard-mode { grid-template-rows: auto 1fr auto; }

        @media (orientation: landscape) {
            body {
                grid-template-columns: 40% 60%;
                grid-template-rows: auto 1fr;
                grid-template-areas: "toolbar keypad" "display keypad";
            }
            body.external-keyboard-mode { grid-template-columns: 70% 30%; }
        }

        /* TOOLBAR */
        .toolbar {
            grid-area: toolbar; display: flex; justify-content: center; align-items: center;
            background: #e2e8f0; z-index: 5; min-height: 40px; padding: 5px; 
            gap: 10px; grid-gap: 10px; 
        }
        
        .btn-header {
            background-color: #2563eb; color: white; border: none; border-radius: 6px;
            padding: 8px 12px; font-size: 14px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 5px;
        }
        #btn-install { display: none; } 

        /* DISPLAY */
        .display-container {
            grid-area: display; background: var(--screen-bg); padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; z-index: 4;
            display: flex; flex-direction: column; overflow: hidden; cursor: pointer; 
        }

        #view-calc { display: flex; flex-direction: column; height: 100%; justify-content: space-between; }

        .receipt-list {
            flex: 1; overflow-y: auto; text-align: right; padding-right: 5px; margin-bottom: 5px;
        }

        /* --- PERBAIKAN UKURAN HURUF ITEM --- */
        .receipt-item {
            font-size: 28px; /* Fallback diperbesar */
            font-size: clamp(1.6rem, 4vh, 2.2rem); 
            color: #334155; 
            font-weight: 600; 
            border-bottom: 1px dashed #e2e8f0; padding: 6px 0;
            line-height: 1.3;
        }
        .receipt-item.active { color: var(--text-main); font-weight: 800; border-bottom: none; }

        .live-total-box {
            background: #f8fafc; border-top: 2px solid #2563eb; padding: 5px 0; text-align: right;
        }

        .total-label { display: block; font-size: 12px; color: var(--text-muted); }
        #main-display { 
            font-size: 40px;
            font-size: clamp(2.5rem, 6vh, 4rem); 
            font-weight: 800; color: var(--text-main); line-height: 1; 
        }

        /* PAYMENT MODE */
        .pay-mode-view { display: none; flex-direction: column; justify-content: space-between; height: 100%; padding: 5px 0; }
        .pay-row { display: flex; justify-content: space-between; align-items: center; }
        .label-pay { font-size: 16px; font-weight: bold; color: #64748b; }
        
        .btn-edit-total {
            background: #f59e0b; border: none; border-radius: 4px; color: white; padding: 5px 10px; font-weight: bold;
        }
        
        #pay-total { font-size: 24px; font-weight: bold; }
        #pay-input-display { 
            font-size: 40px;
            font-size: clamp(2.5rem, 7vh, 4rem); font-weight: 800; text-align: right; border-bottom: 3px solid #2563eb; 
        }
        #pay-change-display {
            font-size: 24px; font-weight: bold; text-align: right; color: var(--btn-save-bg);
        }

        /* KEYPAD */
        .keypad-container {
            grid-area: keypad; padding: 5px; display: grid; 
            gap: 4px; grid-gap: 4px;
            background-color: var(--bg-color);
            height: 100%; overflow-y: auto;
            grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(6, 1fr);
        }

        body.external-keyboard-mode .keypad-container {
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: repeat(2, 60px); 
            align-content: end; height: auto; padding-top: 0;
        }

        button {
            border: none; border-radius: 6px; 
            font-size: 24px;
            font-size: clamp(1.5rem, 4vh, 2.5rem); 
            font-weight: 700; cursor: pointer; color: var(--text-main); background: var(--btn-num-bg);
            box-shadow: 0 2px 0 #cbd5e1; display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%;
        }
        button:active { opacity: 0.7; transform: translateY(2px); }

        body.external-keyboard-mode .virtual-key { display: none !important; }

        .btn-tool { background-color: var(--btn-tool-bg); color: white; font-size: 14px; flex-direction: column; }
        .btn-undo { background-color: #f59e0b; color: white; font-size: 14px; flex-direction: column; }
        .btn-rotate { background-color: var(--btn-rotate-bg); color: white; font-size: 14px; flex-direction: column; }
        
        .btn-op { background-color: var(--btn-op-bg); color: #1e3a8a; }
        .btn-clear { background-color: var(--btn-clear-bg); color: white; font-size: 20px; }
        .btn-pay { background-color: var(--btn-action-bg); color: white; font-size: 16px; text-transform: uppercase; }
        .btn-eq { background-color: #2563eb; color: white; }

        /* Helpers */
        .sw-status { display: none; }
    </style>
</head>
<body id="body-app">

    <div class="toolbar" id="toolbar-area">
        <button class="btn-header" id="btn-install" onclick="installApp()">üì≤ Install</button>
    </div>

    <div class="display-container" id="display-area">
        <div id="view-calc">
            <div id="receipt-list" class="receipt-list"><div class="receipt-item active">0</div></div>
            <div class="live-total-box">
                <span class="total-label">Total Belanja:</span>
                <span id="main-display">0</span>
            </div>
        </div>

        <div id="view-pay" class="pay-mode-view">
            <div class="pay-row">
                <div class="label-group" style="display:flex; gap:5px; align-items:center;">
                    <span class="label-pay">TOTAL</span>
                    <button class="btn-edit-total" onclick="editTransaction()">UBAH</button>
                </div>
                <span id="pay-total">Rp 0</span>
            </div>
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <div style="text-align:right; font-size:14px; color:#64748b;">Uang Pelanggan:</div>
                <div id="pay-input-display">0</div>
            </div>
            <div class="pay-row">
                <span class="label-pay" id="pay-change-label">KEMBALI</span>
                <span id="pay-change-display">Rp 0</span>
            </div>
        </div>
    </div>

    <div class="keypad-container" id="keypad">
        <!-- BARIS 1 -->
        <button class="btn-tool" onclick="toggleSound()" id="btn-sound">üîä<br>Suara</button>
        <button class="btn-tool" onclick="connectBluetooth()" id="btn-bt">üñ®Ô∏è<br>Connect</button>
        <button class="btn-tool" onclick="showHistory()">üìú<br>Riwayat</button>
        <button class="btn-undo" onclick="undoLastAction()">‚Ü©Ô∏è<br>Batal</button>

        <!-- BARIS 2 -->
        <button class="btn-clear" onclick="clearAll()">AC</button>
        <button class="btn-rotate" onclick="toggleOrientation()">‚ü≥<br>Putar</button>
        <button id="btn-main-action" class="btn-pay" onclick="handleMainAction()">BAYAR</button>
        <button class="btn-backspace virtual-key" onclick="backspace()">‚å´</button>

        <!-- BARIS 3 -->
        <button onclick="appendNum('7')" class="virtual-key">7</button>
        <button onclick="appendNum('8')" class="virtual-key">8</button>
        <button onclick="appendNum('9')" class="virtual-key">9</button>
        <button class="btn-op virtual-key" onclick="appendOp('/')">√∑</button>

        <!-- BARIS 4 -->
        <button onclick="appendNum('4')" class="virtual-key">4</button>
        <button onclick="appendNum('5')" class="virtual-key">5</button>
        <button onclick="appendNum('6')" class="virtual-key">6</button>
        <button class="btn-op virtual-key" onclick="appendOp('*')">√ó</button>

        <!-- BARIS 5 -->
        <button onclick="appendNum('1')" class="virtual-key">1</button>
        <button onclick="appendNum('2')" class="virtual-key">2</button>
        <button onclick="appendNum('3')" class="virtual-key">3</button>
        <button class="btn-op virtual-key" onclick="appendOp('-')">-</button>

        <!-- BARIS 6 -->
        <button onclick="appendNum('0')" class="virtual-key">0</button>
        <button class="btn-zero-xx virtual-key" onclick="appendNum('00')">00</button>
        <button class="btn-zero-xx virtual-key" onclick="appendNum('000')">000</button>
        <button class="btn-op virtual-key" onclick="appendOp('+')">+</button>
    </div>

    <script>
        // --- SETUP DASAR ---
        const manifestData={"name":"Kalkulator ADS","short_name":"Kalkulator ADS","start_url":".","display":"standalone","background_color":"#f1f5f9","theme_color":"#2563eb","icons":[{"src":"data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>","sizes":"192x192","type":"image/svg+xml"}]};
        
        const manifestEl = document.getElementById('manifest-placeholder');
        if (manifestEl) {
            manifestEl.setAttribute('href',URL.createObjectURL(new Blob([JSON.stringify(manifestData)],{type:'application/json'})));
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('btn-install').style.display = 'inline-flex'; });
        async function installApp() { if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; document.getElementById('btn-install').style.display='none'; } }
        
        // --- FULLSCREEN & ORIENTASI ---
        async function attemptFullScreen() { 
            if(!document.fullscreenElement && document.documentElement.requestFullscreen){ 
                try { await document.documentElement.requestFullscreen(); } catch(e) {}
            } 
        }
        document.body.addEventListener('click', attemptFullScreen); 
        document.body.addEventListener('touchstart', attemptFullScreen);

        async function toggleOrientation() {
            await attemptFullScreen();
            const type = screen.orientation.type;
            try {
                if (type.startsWith('portrait')) await screen.orientation.lock('landscape');
                else await screen.orientation.lock('portrait');
            } catch (err) {
                console.log("Lock failed:", err);
                try { screen.orientation.unlock(); } catch(e){}
                alert("Gagal mengunci. Pastikan sudah 'Layar Penuh' (klik layar dulu).");
            }
        }

        // --- PWA UPDATE AUTOMATION (PERBAIKAN) ---
        if('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(reg => {
                    // Paksa cek update ke server setiap kali aplikasi dibuka
                    reg.update();

                    // Deteksi jika ada versi baru yang sedang diunduh
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            // Jika versi baru selesai diunduh dan siap
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Kirim sinyal untuk langsung melewati fase "waiting" dan aktifkan
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                }).catch(err => console.log('SW fail', err));

                // Jika Service Worker baru mengambil alih kendali, muat ulang aplikasi agar update tampil
                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            });
        }

        // --- VARIABEL & LOGIC ---
        let expression="", totalBill=0, paymentInput="", isPaymentMode=false, isSoundOn=true;
        let printerDevice=null, printerCharacteristic=null, inputHistory=[], lastTap=0;
        let isPrinting = false; // Tambahan variabel untuk mencegah cetak ganda
        window.audioCtx = null;

        const receiptList = document.getElementById('receipt-list');
        const mainDisplay = document.getElementById('main-display'); 
        const payTotalDisplay = document.getElementById('pay-total');
        const payInputDisplay = document.getElementById('pay-input-display');
        const payChangeDisplay = document.getElementById('pay-change-display');
        const btnMain = document.getElementById('btn-main-action');
        const btnSound = document.getElementById('btn-sound');
        const btnBt = document.getElementById('btn-bt');

        // --- DOUBLE TAP ---
        document.getElementById('display-area').addEventListener('click', (e) => {
            const currentTime = new Date().getTime();
            if ((currentTime - lastTap) < 300 && (currentTime - lastTap) > 0) {
                e.preventDefault(); document.body.classList.toggle('external-keyboard-mode');
            } 
            lastTap = currentTime;
        });

        // --- KEYBOARD & MOUSE ---
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            
            // Cegah aksi default browser untuk tombol kalkulator (seperti scroll)
            if(['+', '-', '*', '/', 'Enter', 'Backspace', 'Escape', '='].includes(key)) event.preventDefault();

            // Aktifkan mode keyboard eksternal otomatis
            if (!document.body.classList.contains('external-keyboard-mode')) {
                document.body.classList.add('external-keyboard-mode');
            }

            if (!isNaN(key) && key !== ' ') {
                appendNum(key);
            } else if (['+', '-', '*', '/'].includes(key)) {
                appendOp(key);
            } else if (key === 'Enter' || key === '=') {
                // LOGIKA ENTER:
                // 1. Mode Hitung -> Pindah ke Bayar
                // 2. Mode Bayar -> Cetak Struk
                handleMainAction();
            } else if (key === 'Backspace') {
                backspace();
            } else if (key === 'Escape') {
                clearAll();
            } else if (key === 'z' && (event.ctrlKey || event.metaKey)) {
                undoLastAction();
            }
        });

        // --- PWA UPDATE AUTOMATION (DISEMPURNAKAN) ---
        if('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(reg => {
                    // Paksa cek update ke server setiap kali aplikasi dibuka
                    reg.update();

                    // Deteksi jika ada versi baru yang sedang diunduh
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            // Jika versi baru selesai diunduh dan siap
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Kirim sinyal untuk langsung melewati fase "waiting" dan aktifkan
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                            }
                        });
                    });
                }).catch(err => console.log('SW fail', err));

                // Jika Service Worker baru mengambil alih kendali, muat ulang aplikasi agar update tampil
                let refreshing;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    window.location.reload();
                    refreshing = true;
                });
            });
        }

        // --- CORE FUNCTIONS ---
        function scrollToBottom() { setTimeout(() => { receiptList.scrollTop = receiptList.scrollHeight; }, 10); }
        
        // Format visual helper
        function formatVisual(text) {
            if (!text) return "";
            let vis = text.replace(/\*/g, ' √ó ').replace(/\//g, ' √∑ ');
            return vis.replace(/\d+/g, (n) => parseInt(n).toLocaleString('id-ID'));
        }

        function initAudio() { if(!window.audioCtx && (window.AudioContext||window.webkitAudioContext)) window.audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        function playClickSound() {
            if(!isSoundOn) return; initAudio(); if(!window.audioCtx) return;
            if(window.audioCtx.state === 'suspended') window.audioCtx.resume();
            const osc = window.audioCtx.createOscillator(); const g = window.audioCtx.createGain();
            osc.connect(g); g.connect(window.audioCtx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(1200, window.audioCtx.currentTime);
            g.gain.setValueAtTime(0.05, window.audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, window.audioCtx.currentTime+0.05);
            osc.start(); osc.stop(window.audioCtx.currentTime+0.05);
        }
        function toggleSound() { isSoundOn = !isSoundOn; btnSound.innerHTML = isSoundOn ? 'üîä<br>Suara' : 'üîá<br>Mute'; if(isSoundOn) playClickSound(); }
        document.getElementById('keypad').addEventListener('click', (e) => { if(e.target.closest('button')) playClickSound(); });

        function saveState() { if(inputHistory.length > 20) inputHistory.shift(); inputHistory.push(expression); }
        function undoLastAction() { if(isPaymentMode) return; if(inputHistory.length>0){ expression = inputHistory.pop(); updateDisplay(); } }

        function updateDisplay() {
            if (!isPaymentMode) {
     
